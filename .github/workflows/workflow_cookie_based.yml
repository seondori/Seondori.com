name: RAM Price Crawler (Cookie-Based.verX)
on:
  schedule:
    # ì •ê°ì—ëŠ” ì„œë²„ ë¶€í•˜ê°€ ë§ì•„ ì§€ì—°ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¶„ ë‹¨ìœ„ë¥¼ ì‚´ì§ ë³€ê²½(ì¶”ì²œ)
    - cron: '5 1 * * *'   # í•œêµ­ì‹œê°„ 10:05
    - cron: '5 4 * * *'   # í•œêµ­ì‹œê°„ 13:05
    - cron: '5 9 * * *'   # í•œêµ­ì‹œê°„ 18:05
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”
jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ê°•ì œ í‘¸ì‹œ ë° ì›Œí¬í”Œë¡œìš° ì¬íŠ¸ë¦¬ê±°ë¥¼ ìœ„í•´ ê¶Œí•œ ìœ ì§€
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Chrome browser
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      # âœ… ChromeDriver ì„¤ì¹˜ ë‹¨ê³„ ì œê±° (webdriver-managerê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬)
      # - name: Install compatible ChromeDriver
      #   uses: nanasess/setup-chromedriver@v2
      #   with:
      #     chromedriver-version: '120.0.6099.217'
      - name: Install Python dependencies
        run: |
          pip install selenium requests webdriver-manager
      - name: Run crawler
        env:
          NAVER_COOKIES: ${{ secrets.NAVER_COOKIES }}
          GITHUB_ACTIONS: true
        run: |
          cd backend
          python crawler_cookie_based_fixed.py
      - name: Check crawler results
        if: always()
        run: |
          if [ -f backend/ram_*.json ]; then
            echo "âœ… í¬ë¡¤ëŸ¬ ê²°ê³¼ íŒŒì¼ í™•ì¸ë¨"
          else
            echo "âš ï¸ ê²°ê³¼ íŒŒì¼ ì—†ìŒ"
          fi
      - name: Commit and push changes
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          # ëª¨ë“  ë³€ê²½ì‚¬í•­ ì¶”ê°€ (JSON ë°ì´í„° ë“±)
          git add -A
          
          # [í•µì‹¬] ë³€ê²½ì‚¬í•­ì´ ì—†ë”ë¼ë„ 'ê°•ì œ ì»¤ë°‹'ì„ ë§Œë“¤ê¸° ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì¼ ìƒì„±
          # ì´ íŒŒì¼ì´ ë§¤ë²ˆ ë°”ë€Œë¯€ë¡œ gitì€ í•­ìƒ ë³€ê²½ì‚¬í•­ì´ ìˆë‹¤ê³  ì¸ì‹í•©ë‹ˆë‹¤.
          date > backend/last_run.txt
          git add backend/last_run.txt
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆë“  ì—†ë“  ë¬´ì¡°ê±´ ì»¤ë°‹ ì§„í–‰
          # '--allow-empty'ëŠ” í˜¹ì‹œë¼ë„ ìœ„ íŒŒì¼ ìƒì„±ì´ ì•ˆ ë˜ì—ˆì„ ë•Œë¥¼ ëŒ€ë¹„í•œ ì•ˆì „ì¥ì¹˜ì…ë‹ˆë‹¤.
          git commit --allow-empty -m "ğŸ¤– ìë™ ì—…ë°ì´íŠ¸: RAM ì‹œì„¸ $(date +'%Y-%m-%d %H:%M') (ê³ ì • íƒ€ì„í¬ì¸íŠ¸)"
          git push
      - name: Trigger Vercel deployment
        if: success()
        run: |
          curl -X POST "https://api.vercel.com/v1/integrations/deploy/${{ secrets.VERCEL_DEPLOY_HOOK }}"    
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: crawler-logs
          path: backend/crawler.log
          retention-days: 7
